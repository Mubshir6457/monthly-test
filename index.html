<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Result Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .navbar {
            background: var(--primary);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        .nav-link.active {
            background: rgba(255,255,255,0.15);
            border-radius: 6px;
        }
        
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border-top: 4px solid var(--secondary);
        }
        
        .section-title {
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 12px;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 1.8rem;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--secondary) 0%, #2980b9 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
        }
        
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .result-table th {
            background: var(--primary);
            color: white;
            text-align: center;
            vertical-align: middle;
            font-weight: 600;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
        }
        
        .result-table td {
            text-align: center;
            vertical-align: middle;
            padding: 10px 8px;
            border: 1px solid #dee2e6;
        }
        
        .subject-header {
            background: #e9ecef;
            font-weight: 600;
        }
        
        .test-type-header {
            background: #495057;
        }
        
        .test-type-col {
            min-width: 100px;
            background: #f8f9fa;
        }
        
        .total-col {
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .obtained-col {
            background: #f0f9ff;
        }
        
        .subject-name {
            font-weight: 600;
            color: var(--primary);
            text-align: left;
            background: #f8f9fa;
        }
        
        .marks-cell {
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .absent-mark {
            color: var(--danger);
            font-weight: 600;
        }
        
        .percentage-cell {
            font-weight: 700;
            color: var(--primary);
            background: #e8f5e9;
        }
        
        .status-pass {
            background: var(--success);
            color: white;
            padding: 6px 15px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .status-fail {
            background: var(--danger);
            color: white;
            padding: 6px 15px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .total-row {
            background: #f8f9fa !important;
            font-weight: 700;
            font-size: 1.1rem;
            border-top: 3px solid var(--primary);
        }
        
        .test-total-header {
            background: #6c757d;
            color: white;
        }
        
        .student-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .student-no-results {
            border-left: 4px solid var(--warning);
        }
        
        .alert-custom {
            border-radius: 8px;
            border-left: 4px solid;
            padding: 15px;
        }
        
        .form-control:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        @media (max-width: 768px) {
            .section-card {
                padding: 20px 15px;
            }
            
            .result-table {
                font-size: 0.85rem;
            }
            
            .result-table th,
            .result-table td {
                padding: 8px 4px;
            }
        }
        
        .footer {
            background: var(--primary);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .no-results-badge {
            background: var(--warning);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-graduation-cap me-2"></i>
                Result Management System
            </a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" href="#" id="homeLink">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="checkResultLink">Check Result</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="adminLink">Admin</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink" style="display:none;">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-4" id="contentArea">
        <!-- Home Section -->
        <div id="homeSection">
            <div class="section-card text-center">
                <h1 class="display-5 mb-3">Student Result Management System</h1>
                <p class="lead mb-4">Access academic results with detailed test-wise analysis</p>
                <button class="btn btn-primary-custom btn-lg" id="goToCheckResult">
                    Check Your Result Now
                </button>
            </div>
            <div class="row mt-4">
                <div class="col-md-4 mb-3">
                    <div class="section-card text-center h-100">
                        <div class="mb-3 text-primary">
                            <i class="fas fa-bolt fa-3x"></i>
                        </div>
                        <h5>Instant Results</h5>
                        <p>Quick access to results by roll number</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="section-card text-center h-100">
                        <div class="mb-3 text-primary">
                            <i class="fas fa-chart-bar fa-3x"></i>
                        </div>
                        <h5>Test-wise Analysis</h5>
                        <p>T1, T2, T3 with separate Total/Obtained columns</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="section-card text-center h-100">
                        <div class="mb-3 text-primary">
                            <i class="fas fa-shield-alt fa-3x"></i>
                        </div>
                        <h5>Secure System</h5>
                        <p>Protected by Firebase Authentication</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check Result Section -->
        <div id="checkResultSection" style="display:none;">
            <div class="section-card">
                <h2 class="section-title">Check Student Result</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Enter Roll Number</label>
                            <input type="text" class="form-control form-control-lg" id="rollNumber" placeholder="e.g., 0283, 0123">
                            <div class="form-text">Only roll numbers starting with 0 are allowed</div>
                        </div>
                        <button class="btn btn-primary-custom w-100 py-3" id="fetchResultBtn">
                            <i class="fas fa-search me-2"></i>Fetch Result
                        </button>
                        <div id="rollMessage" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div id="resultDisplaySection"></div>
        </div>

        <!-- Admin Login -->
        <div id="authSection" style="display:none;">
            <div class="section-card" style="max-width: 500px; margin: 0 auto;">
                <h2 class="section-title">Admin Login</h2>
                <div class="mb-3">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email" placeholder="admin@example.com">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" placeholder="Enter password">
                </div>
                <button class="btn btn-primary-custom w-100 py-2" id="loginBtn">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <div id="authMessage" class="mt-3"></div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminSection" style="display:none;">
            <h2 class="section-title mb-4"><i class="fas fa-user-shield me-2"></i>Admin Panel</h2>
            
            <!-- Add Student -->
            <div class="section-card mb-4">
                <h5 class="mb-3"><i class="fas fa-user-plus me-2"></i>Add New Student</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="addRollNumber" placeholder="Roll Number (0283)">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="addStudentName" placeholder="Full Name">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary-custom w-100" id="addStudentBtn">Add Student</button>
                    </div>
                </div>
                <div id="addStudentMessage" class="mt-3"></div>
            </div>

            <!-- Add/Update Marks -->
            <div class="section-card mb-4">
                <h5 class="mb-3"><i class="fas fa-edit me-2"></i>Add/Update Marks</h5>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="updateRollNumber" placeholder="Roll Number">
                    </div>
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="studentName" placeholder="Student Name" readonly>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="subject" placeholder="Subject">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="testType" placeholder="T1/T2/Final" value="Final">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="totalMarks" value="100">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="obtainedMarks" placeholder="Marks or 'A'">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary-custom w-100" id="addMarksBtn">Save</button>
                    </div>
                </div>
                <div id="updateMarksMessage" class="mt-3"></div>
            </div>

            <!-- All Students -->
            <div class="section-card mb-4">
                <h5 class="mb-3"><i class="fas fa-list me-2"></i>All Students</h5>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="searchStudent" placeholder="Search by roll number or name">
                    <button class="btn btn-primary-custom" id="searchBtn">Search</button>
                </div>
                <div id="allResultsDisplay"></div>
            </div>

            <!-- Delete Options -->
            <div class="section-card mb-4">
                <h5 class="mb-3"><i class="fas fa-trash me-2"></i>Delete Options</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="deleteRollNumber" placeholder="Enter Roll Number">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-warning w-100" id="deleteResultBtn">Delete Results Only</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-danger w-100" id="deleteStudentBtn">Delete Complete Student</button>
                    </div>
                </div>
                <div id="deleteMessage" class="mt-3"></div>
            </div>

            <!-- Export -->
            <div class="section-card">
                <h5 class="mb-3"><i class="fas fa-file-excel me-2"></i>Export Data</h5>
                <button class="btn btn-success w-100 py-3" id="exportExcelBtn">
                    <i class="fas fa-file-excel me-2"></i>Export All Results to Excel
                </button>
                <div id="exportMessage" class="mt-3"></div>
            </div>
        </div>
    </div>

    <footer class="footer text-center">
        <div class="container">
            <p class="mb-0">Student Result Management System Â© 2023 | Firebase Integrated</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAlXd1v5IZwaEROAdfKMXMUPflIorWV4Zg",
            authDomain: "students-51da1.firebaseapp.com",
            databaseURL: "https://students-51da1-default-rtdb.firebaseio.com",
            projectId: "students-51da1",
            storageBucket: "students-51da1.firebasestorage.app",
            messagingSenderId: "785878911811",
            appId: "1:785878911811:web:5a0a480d3ceca57976bdf6",
            measurementId: "G-839CVJXZ0E"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const { jsPDF } = window.jspdf;

        // DOM Elements
        const sections = ['homeSection', 'checkResultSection', 'authSection', 'adminSection'];
        let currentUser = null;
        let currentResultData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation
            document.getElementById('homeLink').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('checkResultLink').addEventListener('click', () => showSection('checkResultSection'));
            document.getElementById('adminLink').addEventListener('click', () => {
                if (currentUser) {
                    showSection('adminSection');
                    loadAllStudents();
                } else {
                    showSection('authSection');
                }
            });
            document.getElementById('goToCheckResult').addEventListener('click', () => showSection('checkResultSection'));
            document.getElementById('logoutLink').addEventListener('click', logout);

            // Authentication
            document.getElementById('loginBtn').addEventListener('click', login);

            // Result Functions
            document.getElementById('fetchResultBtn').addEventListener('click', fetchResult);

            // Admin Functions
            document.getElementById('addStudentBtn').addEventListener('click', addStudent);
            document.getElementById('addMarksBtn').addEventListener('click', addMarks);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('deleteResultBtn').addEventListener('click', deleteResults);
            document.getElementById('deleteStudentBtn').addEventListener('click', deleteStudent);
            document.getElementById('searchBtn').addEventListener('click', searchStudents);
            
            // Auto-fill student name
            document.getElementById('updateRollNumber').addEventListener('change', autoFillName);

            // Auth state listener
            auth.onAuthStateChanged(user => {
                currentUser = user;
                document.getElementById('logoutLink').style.display = user ? 'block' : 'none';
            });

            // Show check result by default
            showSection('checkResultSection');
        });

        // Navigation Functions
        function showSection(sectionId) {
            sections.forEach(id => {
                document.getElementById(id).style.display = id === sectionId ? 'block' : 'none';
            });
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const activeLink = sectionId === 'homeSection' ? 'homeLink' : 
                              sectionId === 'checkResultSection' ? 'checkResultLink' : 
                              sectionId === 'adminSection' ? 'adminLink' : null;
            if (activeLink) document.getElementById(activeLink).classList.add('active');
        }

        // Authentication
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showMessage('authMessage', 'Logging in...', 'info');
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showMessage('authMessage', 'Login successful!', 'success');
                    setTimeout(() => {
                        showSection('adminSection');
                        loadAllStudents();
                    }, 1000);
                })
                .catch(error => {
                    showMessage('authMessage', `Login failed: ${error.message}`, 'danger');
                });
        }

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                showSection('checkResultSection');
            });
        }

        // Result Functions
        function fetchResult() {
            const rollNumber = document.getElementById('rollNumber').value.trim();
            
            // FIXED: Validate roll number starts with 0
            if (!rollNumber.startsWith('0')) {
                showMessage('rollMessage', 'Roll number must start with 0', 'danger');
                return;
            }
            
            showMessage('rollMessage', 'Fetching result...', 'info');
            
            database.ref('students/' + rollNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        displayResult(snapshot.val(), rollNumber);
                    } else {
                        showMessage('rollMessage', 'Student not found', 'danger');
                    }
                })
                .catch(error => {
                    showMessage('rollMessage', `Error: ${error.message}`, 'danger');
                });
        }

        function displayResult(studentData, rollNumber) {
            currentResultData = { studentData, rollNumber };
            let html = `
                <div class="section-card">
                    <div class="result-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h3 class="mb-2">${studentData.name || 'N/A'}</h3>
                                <p class="mb-0"><i class="fas fa-id-card me-2"></i>Roll No: ${rollNumber}</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <!-- FIXED: Corrected downloadPDF call -->
                                <button class="btn btn-light" id="downloadPDFBtn">
                                    <i class="fas fa-file-pdf me-2"></i>Download PDF
                                </button>
                            </div>
                        </div>
                    </div>`;
            
            if (studentData.subjects && Object.keys(studentData.subjects).length > 0) {
                const subjects = Object.keys(studentData.subjects);
                let overallTotal = 0, overallObtained = 0;
                const testTypes = new Set();
                
                // Collect all test types
                subjects.forEach(subject => {
                    Object.keys(studentData.subjects[subject]).forEach(testType => {
                        testTypes.add(testType.replace(/_/g, ' ').toUpperCase());
                    });
                });
                
                // Sort test types: T1, T2, T3... then others
                const testTypesArray = Array.from(testTypes).sort((a, b) => {
                    if (a.startsWith('T') && b.startsWith('T')) {
                        const aNum = parseInt(a.substring(1)) || 0;
                        const bNum = parseInt(b.substring(1)) || 0;
                        return aNum - bNum;
                    } else if (a.startsWith('T')) return -1;
                    else if (b.startsWith('T')) return 1;
                    else return a.localeCompare(b);
                });
                
                // Initialize test type totals
                const testTypeTotals = {};
                testTypesArray.forEach(testType => {
                    testTypeTotals[testType] = { total: 0, obtained: 0 };
                });
                
                html += `<div class="table-container">
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th class="subject-header" rowspan="2">Subject</th>`;
                
                // Add test type headers with colspan 2 for Total/Obtained
                testTypesArray.forEach(testType => {
                    html += `<th class="test-type-header" colspan="2">${testType}</th>`;
                });
                
                html += `<th class="test-total-header" colspan="2">All Test Total Marks</th>
                        <th class="subject-header" rowspan="2">%age</th>
                        <th class="subject-header" rowspan="2">Status</th>
                    </tr>
                    <tr>`;
                
                // Add sub-headers for Total and Obtained for each test type
                testTypesArray.forEach(() => {
                    html += `<th class="test-type-col">Total</th>
                            <th class="obtained-col">Obtained</th>`;
                });
                
                html += `<th class="total-col">Total</th>
                        <th class="obtained-col">Obtained</th>
                    </tr>
                    </thead>
                    <tbody>`;
                
                // Add subject rows
                subjects.forEach(subjectName => {
                    const subject = studentData.subjects[subjectName];
                    let subjectTotal = 0, subjectObtained = 0;
                    
                    html += `<tr><td class="subject-name">${subjectName}</td>`;
                    
                    // Add test type marks in Total/Obtained columns
                    testTypesArray.forEach(testType => {
                        const testTypeKey = testType.replace(/\s+/g, '_');
                        if (subject[testTypeKey]) {
                            const marks = subject[testTypeKey];
                            const total = marks.total || 0;
                            const obtained = marks.obtained || 'A';
                            const isAbsent = obtained === 'A';
                            const obtainedNum = isAbsent ? 0 : parseFloat(obtained);
                            
                            subjectTotal += total;
                            if (!isAbsent) {
                                subjectObtained += obtainedNum;
                                testTypeTotals[testType].obtained += obtainedNum;
                            }
                            testTypeTotals[testType].total += total;
                            
                            html += `<td class="total-col marks-cell">${total}</td>
                                    <td class="obtained-col marks-cell ${isAbsent ? 'absent-mark' : ''}">
                                        ${isAbsent ? 'A' : obtained}
                                    </td>`;
                        } else {
                            html += `<td class="total-col">-</td><td class="obtained-col">-</td>`;
                        }
                    });
                    
                    const percentage = subjectTotal > 0 ? ((subjectObtained / subjectTotal) * 100).toFixed(2) : 0;
                    const status = percentage >= 50 ? 'PASS' : 'FAIL';
                    
                    overallTotal += subjectTotal;
                    overallObtained += subjectObtained;
                    
                    html += `<td class="total-col">${subjectTotal}</td>
                            <td class="obtained-col">${subjectObtained}</td>
                            <td class="percentage-cell">${percentage}%</td>
                            <td><span class="${status === 'PASS' ? 'status-pass' : 'status-fail'}">${status}</span></td>
                        </tr>`;
                });
                
                // Add total row
                const overallPercentage = overallTotal > 0 ? ((overallObtained / overallTotal) * 100).toFixed(2) : 0;
                const overallStatus = overallPercentage >= 50 ? 'PASS' : 'FAIL';
                
                html += `<tr class="total-row">
                    <td class="subject-name">GRAND TOTAL</td>`;
                
                // Add test type totals
                testTypesArray.forEach(testType => {
                    const total = testTypeTotals[testType];
                    html += `<td class="total-col">${total.total}</td>
                            <td class="obtained-col">${total.obtained}</td>`;
                });
                
                html += `<td class="total-col">${overallTotal}</td>
                        <td class="obtained-col">${overallObtained}</td>
                        <td class="percentage-cell">${overallPercentage}%</td>
                        <td><span class="${overallStatus === 'PASS' ? 'status-pass' : 'status-fail'}">
                            ${overallStatus}
                        </span></td>
                    </tr>`;
                
                html += `</tbody></table></div>`;
                
                // Add test type summary
                html += `<div class="mt-4">
                    <h5><i class="fas fa-chart-pie me-2"></i>Test Type Performance Summary</h5>
                    <div class="row mt-3">`;
                
                testTypesArray.forEach(testType => {
                    const total = testTypeTotals[testType];
                    const percentage = total.total > 0 ? ((total.obtained / total.total) * 100).toFixed(2) : 0;
                    const progressColor = percentage >= 75 ? 'success' : percentage >= 50 ? 'warning' : 'danger';
                    
                    html += `
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="card-title mb-2">${testType}</h6>
                                    <div class="mb-2">
                                        <span class="h4 text-${progressColor}">${percentage}%</span>
                                    </div>
                                    <p class="card-text small mb-0">
                                        <span class="text-primary">${total.obtained}</span> / 
                                        <span class="text-secondary">${total.total}</span>
                                    </p>
                                </div>
                            </div>
                        </div>`;
                });
                
                html += `</div></div>`;
            } else {
                html += `<div class="alert alert-info alert-custom">
                    <i class="fas fa-info-circle me-2"></i>
                    Student registered but no results available yet. Add marks from Admin Panel.
                </div>`;
            }
            
            html += `</div>`;
            document.getElementById('resultDisplaySection').innerHTML = html;
            showMessage('rollMessage', '', 'success');
            
            // FIXED: Add event listener to the download button after it's created
            document.getElementById('downloadPDFBtn').addEventListener('click', downloadPDF);
        }

        // FIXED: downloadPDF function - Properly implemented
        function downloadPDF() {
            if (!currentResultData) return;
            const { studentData, rollNumber } = currentResultData;
            
            // Create a new jsPDF instance
            const doc = new jsPDF('l', 'mm', 'a4'); // landscape mode
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text(`Student Result - ${studentData.name || 'N/A'}`, 20, 20);
            
            // Add roll number
            doc.setFontSize(12);
            doc.text(`Roll Number: ${rollNumber}`, 20, 30);
            
            if (studentData.subjects && Object.keys(studentData.subjects).length > 0) {
                const subjects = Object.keys(studentData.subjects);
                const testTypes = new Set();
                
                // Collect all test types
                subjects.forEach(subject => {
                    Object.keys(studentData.subjects[subject]).forEach(testType => {
                        testTypes.add(testType.replace(/_/g, ' ').toUpperCase());
                    });
                });
                
                // Sort test types
                const testTypesArray = Array.from(testTypes).sort((a, b) => {
                    if (a.startsWith('T') && b.startsWith('T')) {
                        const aNum = parseInt(a.substring(1)) || 0;
                        const bNum = parseInt(b.substring(1)) || 0;
                        return aNum - bNum;
                    } else if (a.startsWith('T')) return -1;
                    else if (b.startsWith('T')) return 1;
                    else return a.localeCompare(b);
                });
                
                // Create table data
                const tableData = [];
                const headers = ['Subject'];
                
                // Add headers for test types
                testTypesArray.forEach(testType => {
                    headers.push(`${testType} Total`, `${testType} Obtained`);
                });
                headers.push('Total', 'Obtained', 'Percentage', 'Status');
                
                // Add subject rows
                subjects.forEach(subjectName => {
                    const subject = studentData.subjects[subjectName];
                    const rowData = [subjectName];
                    let subjectTotal = 0, subjectObtained = 0;
                    
                    testTypesArray.forEach(testType => {
                        const testTypeKey = testType.replace(/\s+/g, '_');
                        if (subject[testTypeKey]) {
                            const marks = subject[testTypeKey];
                            const total = marks.total || 0;
                            const obtained = marks.obtained || 'A';
                            subjectTotal += total;
                            if (obtained !== 'A') subjectObtained += parseFloat(obtained);
                            
                            rowData.push(total, obtained);
                        } else {
                            rowData.push('-', '-');
                        }
                    });
                    
                    const percentage = subjectTotal > 0 ? ((subjectObtained / subjectTotal) * 100).toFixed(2) : 0;
                    const status = subjectTotal > 0 && percentage >= 50 ? 'PASS' : 'FAIL';
                    
                    rowData.push(subjectTotal, subjectObtained, percentage + '%', status);
                    tableData.push(rowData);
                });
                
                // Calculate overall totals
                let overallTotal = 0, overallObtained = 0;
                subjects.forEach(subjectName => {
                    const subject = studentData.subjects[subjectName];
                    testTypesArray.forEach(testType => {
                        const testTypeKey = testType.replace(/\s+/g, '_');
                        if (subject[testTypeKey]) {
                            const marks = subject[testTypeKey];
                            const total = marks.total || 0;
                            const obtained = marks.obtained || 'A';
                            overallTotal += total;
                            if (obtained !== 'A') overallObtained += parseFloat(obtained);
                        }
                    });
                });
                
                const overallPercentage = overallTotal > 0 ? ((overallObtained / overallTotal) * 100).toFixed(2) : 0;
                const overallStatus = overallTotal > 0 && overallPercentage >= 50 ? 'PASS' : 'FAIL';
                
                // Add total row
                const totalRow = ['GRAND TOTAL'];
                testTypesArray.forEach(testType => {
                    const testTypeKey = testType.replace(/\s+/g, '_');
                    let testTypeTotal = 0, testTypeObtained = 0;
                    
                    subjects.forEach(subjectName => {
                        const subject = studentData.subjects[subjectName];
                        if (subject[testTypeKey]) {
                            const marks = subject[testTypeKey];
                            testTypeTotal += marks.total || 0;
                            const obtained = marks.obtained || 'A';
                            if (obtained !== 'A') testTypeObtained += parseFloat(obtained);
                        }
                    });
                    
                    totalRow.push(testTypeTotal, testTypeObtained);
                });
                
                totalRow.push(overallTotal, overallObtained, overallPercentage + '%', overallStatus);
                tableData.push(totalRow);
                
                // Generate table using autoTable
                doc.autoTable({
                    startY: 40,
                    head: [headers],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [44, 62, 80],
                        textColor: [255, 255, 255],
                        fontSize: 10
                    },
                    bodyStyles: { fontSize: 9 },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    margin: { left: 10, right: 10 },
                    styles: { overflow: 'linebreak', cellWidth: 'wrap' },
                    columnStyles: {
                        0: { cellWidth: 30 },
                    }
                });
                
                // Add footer with date
                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Generated on ${new Date().toLocaleDateString()} - Page ${i} of ${pageCount}`, 10, doc.internal.pageSize.height - 10);
                }
            } else {
                doc.setFontSize(14);
                doc.text("No results available for this student.", 20, 50);
            }
            
            // Save the PDF
            doc.save(`Result_${rollNumber}.pdf`);
        }

        // Admin Functions
        function addStudent() {
            const rollNo = document.getElementById('addRollNumber').value.trim();
            const name = document.getElementById('addStudentName').value.trim();
            
            // FIXED: Only allow roll numbers starting with 0
            if (!rollNo.startsWith('0') || !name) {
                showMessage('addStudentMessage', 'Invalid data. Roll number must start with 0.', 'danger');
                return;
            }
            
            database.ref('students/' + rollNo).set({
                name: name,
                subjects: {}
            }).then(() => {
                showMessage('addStudentMessage', 'Student added successfully', 'success');
                document.getElementById('addRollNumber').value = '';
                document.getElementById('addStudentName').value = '';
                loadAllStudents();
            }).catch(error => {
                showMessage('addStudentMessage', `Error: ${error.message}`, 'danger');
            });
        }

        function addMarks() {
            const rollNo = document.getElementById('updateRollNumber').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const testType = document.getElementById('testType').value.toUpperCase().replace(/\s+/g, '_');
            const totalMarks = document.getElementById('totalMarks').value;
            const obtainedMarks = document.getElementById('obtainedMarks').value;
            
            // FIXED: Validate roll number starts with 0
            if (!rollNo.startsWith('0') || !subject || !testType || !totalMarks) {
                showMessage('updateMarksMessage', 'Please fill all fields correctly. Roll number must start with 0.', 'danger');
                return;
            }
            
            database.ref('students/' + rollNo).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showMessage('updateMarksMessage', 'Student not found. Please add student first.', 'danger');
                        return;
                    }
                    
                    const studentData = snapshot.val();
                    const updates = {
                        name: studentData.name,
                        subjects: studentData.subjects || {}
                    };
                    
                    if (!updates.subjects[subject]) updates.subjects[subject] = {};
                    updates.subjects[subject][testType] = {
                        total: parseFloat(totalMarks),
                        obtained: obtainedMarks.toUpperCase()
                    };
                    
                    return database.ref('students/' + rollNo).set(updates);
                })
                .then(() => {
                    showMessage('updateMarksMessage', 'Marks saved successfully', 'success');
                    loadAllStudents();
                })
                .catch(error => {
                    showMessage('updateMarksMessage', `Error: ${error.message}`, 'danger');
                });
        }

        function autoFillName() {
            const rollNo = document.getElementById('updateRollNumber').value.trim();
            if (rollNo.startsWith('0')) {
                database.ref('students/' + rollNo).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            document.getElementById('studentName').value = snapshot.val().name || '';
                        } else {
                            document.getElementById('studentName').value = '';
                        }
                    });
            }
        }

        function loadAllStudents() {
            database.ref('students').once('value')
                .then(snapshot => {
                    const allStudents = snapshot.val();
                    let html = '';
                    
                    if (allStudents) {
                        Object.keys(allStudents).forEach(rollNo => {
                            const student = allStudents[rollNo];
                            let totalMarks = 0, obtainedMarks = 0;
                            let hasResults = false;
                            
                            if (student.subjects && Object.keys(student.subjects).length > 0) {
                                hasResults = true;
                                Object.keys(student.subjects).forEach(subject => {
                                    Object.keys(student.subjects[subject]).forEach(testType => {
                                        const marks = student.subjects[subject][testType];
                                        const obtained = marks.obtained || 'A';
                                        if (obtained !== 'A') obtainedMarks += parseFloat(obtained);
                                        totalMarks += parseFloat(marks.total || 0);
                                    });
                                });
                            }
                            
                            const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
                            let statusClass = 'status-pass';
                            let statusText = 'No Results';
                            
                            if (hasResults) {
                                statusClass = percentage >= 50 ? 'status-pass' : 'status-fail';
                                statusText = percentage >= 50 ? 'PASS' : 'FAIL';
                            }
                            
                            html += `
                                <div class="student-card ${!hasResults ? 'student-no-results' : ''}">
                                    <div class="row align-items-center">
                                        <div class="col-md-5">
                                            <h6 class="mb-1 fw-bold">${student.name || 'N/A'}</h6>
                                            <small class="text-muted">Roll No: ${rollNo}</small>
                                        </div>
                                        <div class="col-md-4">
                                            ${hasResults ? `
                                                <span class="${statusClass}">${percentage}%</span>
                                                <small class="text-muted ms-2">${obtainedMarks}/${totalMarks}</small>
                                            ` : `
                                                <span class="no-results-badge">No Results Yet</span>
                                            `}
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <button class="btn btn-sm btn-primary" onclick="viewStudent('${rollNo}')">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary ms-1" onclick="editStudent('${rollNo}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>`;
                        });
                    } else {
                        html = '<div class="alert alert-warning alert-custom">No students found in database</div>';
                    }
                    
                    document.getElementById('allResultsDisplay').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading students:', error);
                    document.getElementById('allResultsDisplay').innerHTML = 
                        '<div class="alert alert-danger alert-custom">Error loading students</div>';
                });
        }

        function viewStudent(rollNo) {
            document.getElementById('rollNumber').value = rollNo;
            showSection('checkResultSection');
            setTimeout(fetchResult, 100);
        }

        function editStudent(rollNo) {
            document.getElementById('updateRollNumber').value = rollNo;
            autoFillName();
        }

        function searchStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            database.ref('students').once('value')
                .then(snapshot => {
                    const allStudents = snapshot.val();
                    let html = '';
                    let found = false;
                    
                    if (allStudents) {
                        Object.keys(allStudents).forEach(rollNo => {
                            const student = allStudents[rollNo];
                            if (rollNo.includes(searchTerm) || (student.name && student.name.toLowerCase().includes(searchTerm))) {
                                found = true;
                                let totalMarks = 0, obtainedMarks = 0;
                                let hasResults = false;
                                
                                if (student.subjects && Object.keys(student.subjects).length > 0) {
                                    hasResults = true;
                                    Object.keys(student.subjects).forEach(subject => {
                                        Object.keys(student.subjects[subject]).forEach(testType => {
                                            const marks = student.subjects[subject][testType];
                                            const obtained = marks.obtained || 'A';
                                            if (obtained !== 'A') obtainedMarks += parseFloat(obtained);
                                            totalMarks += parseFloat(marks.total || 0);
                                        });
                                    });
                                }
                                
                                const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
                                
                                html += `
                                    <div class="student-card ${!hasResults ? 'student-no-results' : ''}">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <h6 class="mb-1 fw-bold">${student.name || 'N/A'}</h6>
                                                <small class="text-muted">Roll No: ${rollNo}</small>
                                                ${hasResults ? 
                                                    `<small class="d-block mt-1">Marks: ${obtainedMarks}/${totalMarks} (${percentage}%)</small>` : 
                                                    `<small class="d-block mt-1 text-warning">No results available</small>`
                                                }
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <button class="btn btn-sm btn-primary" onclick="viewStudent('${rollNo}')">
                                                    View Result
                                                </button>
                                            </div>
                                        </div>
                                    </div>`;
                            }
                        });
                    }
                    
                    if (!found) {
                        html = '<div class="alert alert-warning alert-custom">No students found matching your search</div>';
                    }
                    
                    document.getElementById('allResultsDisplay').innerHTML = html;
                });
        }

        function deleteResults() {
            const rollNo = document.getElementById('deleteRollNumber').value.trim();
            
            if (!rollNo.startsWith('0')) {
                showMessage('deleteMessage', 'Please enter a valid roll number starting with 0', 'danger');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ONLY the result data for roll number ${rollNo}?\n\nStudent name will be preserved.`)) {
                return;
            }
            
            showMessage('deleteMessage', 'Deleting student results only...', 'info');
            
            database.ref('students/' + rollNo).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showMessage('deleteMessage', 'Student not found', 'danger');
                        return;
                    }
                    
                    const studentData = snapshot.val();
                    const studentName = studentData.name || '';
                    
                    // Update only the subjects to empty object, keep the name
                    return database.ref('students/' + rollNo).update({
                        subjects: {}
                    });
                })
                .then(() => {
                    showMessage('deleteMessage', `Results deleted successfully for ${rollNo}! Student name preserved.`, 'success');
                    document.getElementById('deleteRollNumber').value = '';
                    
                    loadAllStudents();
                })
                .catch(error => {
                    showMessage('deleteMessage', `Error deleting results: ${error.message}`, 'danger');
                    console.error("Error deleting results:", error);
                });
        }

        function deleteStudent() {
            const rollNo = document.getElementById('deleteRollNumber').value.trim();
            
            if (!rollNo.startsWith('0')) {
                showMessage('deleteMessage', 'Please enter a valid roll number starting with 0', 'danger');
                return;
            }
            
            if (!confirm(`WARNING: Are you sure you want to COMPLETELY delete student ${rollNo}?\n\nThis will remove ALL student data including name. This action cannot be undone!`)) {
                return;
            }
            
            showMessage('deleteMessage', 'Deleting complete student record...', 'info');
            
            database.ref('students/' + rollNo).remove()
                .then(() => {
                    showMessage('deleteMessage', `Student ${rollNo} completely deleted!`, 'success');
                    document.getElementById('deleteRollNumber').value = '';
                    
                    loadAllStudents();
                })
                .catch(error => {
                    showMessage('deleteMessage', `Error deleting student: ${error.message}`, 'danger');
                });
        }

        function exportToExcel() {
            showMessage('exportMessage', 'Preparing Excel file...', 'info');
            
            database.ref('students').once('value')
                .then(snapshot => {
                    const allStudents = snapshot.val();
                    const wb = XLSX.utils.book_new();
                    
                    if (allStudents) {
                        Object.keys(allStudents).forEach(rollNo => {
                            const student = allStudents[rollNo];
                            const sheetData = [
                                [`Student: ${student.name || 'N/A'} (${rollNo})`],
                                [],
                                ['Subject', 'Test Type', 'Total Marks', 'Obtained Marks', 'Status']
                            ];
                            
                            if (student.subjects && Object.keys(student.subjects).length > 0) {
                                Object.keys(student.subjects).forEach(subject => {
                                    Object.keys(student.subjects[subject]).forEach(testType => {
                                        const marks = student.subjects[subject][testType];
                                        const obtained = marks.obtained || 'A';
                                        const total = marks.total || 0;
                                        const displayTestType = testType.replace(/_/g, ' ');
                                        const status = obtained === 'A' ? 'ABSENT' : 
                                            (parseFloat(obtained) / total >= 0.5 ? 'PASS' : 'FAIL');
                                        
                                        sheetData.push([
                                            subject,
                                            displayTestType,
                                            total,
                                            obtained,
                                            status
                                        ]);
                                    });
                                });
                            } else {
                                sheetData.push(['', 'No results available', '', '', '']);
                            }
                            
                            const ws = XLSX.utils.aoa_to_sheet(sheetData);
                            XLSX.utils.book_append_sheet(wb, ws, rollNo.substring(0, 31));
                        });
                    }
                    
                    XLSX.writeFile(wb, 'Student_Results.xlsx');
                    showMessage('exportMessage', 'Excel file exported successfully!', 'success');
                })
                .catch(error => {
                    showMessage('exportMessage', `Error exporting data: ${error.message}`, 'danger');
                });
        }

        // Utility Functions
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'danger' ? 'alert-danger' : 
                             type === 'warning' ? 'alert-warning' : 'alert-info';
            element.innerHTML = `<div class="alert ${alertClass} alert-custom">${message}</div>`;
            if (type === 'success') {
                setTimeout(() => element.innerHTML = '', 3000);
            }
        }
    </script>
</body>
</html>